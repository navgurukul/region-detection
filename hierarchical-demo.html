<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hierarchical OCR Demo - Screen Region Detector</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.primary {
      background: #007bff;
      color: white;
    }

    button.primary:hover {
      background: #0056b3;
    }

    button.secondary {
      background: #6c757d;
      color: white;
    }

    button.secondary:hover {
      background: #545b62;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .level-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .level-btn {
      padding: 8px 16px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .level-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .video-container {
      position: relative;
      margin-bottom: 20px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    video, canvas {
      width: 100%;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .results {
      margin-top: 20px;
    }

    .result-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }

    .result-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .result-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      font-size: 14px;
      border: 1px solid #e0e0e0;
    }

    .result-item .text {
      color: #333;
      margin-bottom: 5px;
    }

    .result-item .meta {
      color: #666;
      font-size: 12px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
    }

    .badge.code {
      background: #28a745;
      color: white;
    }

    .badge.text {
      background: #007bff;
      color: white;
    }

    .badge.bold {
      background: #ffc107;
      color: #333;
    }

    .badge.italic {
      background: #17a2b8;
      color: white;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Hierarchical OCR Demo</h1>
    <p class="subtitle">Detect blocks, paragraphs, lines, words, and characters from your screen</p>

    <div class="controls">
      <button id="startBtn" class="primary">Start Screen Capture</button>
      <button id="stopBtn" class="secondary" disabled>Stop</button>
      <button id="detectBtn" class="primary" disabled>Run Detection</button>
    </div>

    <div class="level-selector">
      <button class="level-btn active" data-level="all">All Levels</button>
      <button class="level-btn" data-level="block">Blocks</button>
      <button class="level-btn" data-level="paragraph">Paragraphs</button>
      <button class="level-btn" data-level="line">Lines</button>
      <button class="level-btn" data-level="word">Words</button>
      <button class="level-btn" data-level="symbol">Symbols</button>
    </div>

    <div class="loading" id="loading">
      <p>‚è≥ Initializing Tesseract OCR... (this may take 10-20 seconds)</p>
    </div>

    <div class="video-container" id="videoContainer" style="display: none;">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="blockCount">0</div>
        <div class="stat-label">Blocks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="paragraphCount">0</div>
        <div class="stat-label">Paragraphs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lineCount">0</div>
        <div class="stat-label">Lines</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="wordCount">0</div>
        <div class="stat-label">Words</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="symbolCount">0</div>
        <div class="stat-label">Symbols</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="processingTime">0ms</div>
        <div class="stat-label">Processing Time</div>
      </div>
    </div>

    <div class="results" id="results"></div>
  </div>

  <script type="module">
    import { HierarchicalOCRDetector } from './src/hierarchicalOCR.ts';

    let detector = null;
    let stream = null;
    let selectedLevel = 'all';

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const detectBtn = document.getElementById('detectBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const loading = document.getElementById('loading');
    const videoContainer = document.getElementById('videoContainer');
    const stats = document.getElementById('stats');
    const results = document.getElementById('results');

    // Level selector
    document.querySelectorAll('.level-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLevel = btn.dataset.level;
      });
    });

    // Initialize detector
    async function initialize() {
      loading.classList.add('show');
      detector = new HierarchicalOCRDetector();
      await detector.initialize();
      loading.classList.remove('show');
      console.log('‚úì Detector ready');
    }

    // Start screen capture
    startBtn.addEventListener('click', async () => {
      try {
        if (!detector) await initialize();

        stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        video.srcObject = stream;
        await video.play();

        videoContainer.style.display = 'block';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        detectBtn.disabled = false;
      } catch (error) {
        alert('Failed to start screen capture: ' + error.message);
      }
    });

    // Stop
    stopBtn.addEventListener('click', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;
      videoContainer.style.display = 'none';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      detectBtn.disabled = true;
      stats.style.display = 'none';
      results.innerHTML = '';
    });

    // Run detection
    detectBtn.addEventListener('click', async () => {
      if (!detector || !video.videoWidth) return;

      detectBtn.disabled = true;
      detectBtn.textContent = 'Detecting...';

      try {
        // Capture frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Detect
        let result;
        if (selectedLevel === 'all') {
          result = await detector.detect(imageData, {
            includeBlocks: true,
            includeParagraphs: true,
            includeLines: true,
            includeWords: true,
            includeSymbols: true,
            minConfidence: 60,
            detectCode: true,
          });
        } else {
          const items = await detector.detectLevel(imageData, selectedLevel, {
            minConfidence: 60,
          });
          result = { [selectedLevel + 's']: items, processingTime: 0 };
        }

        // Update stats
        stats.style.display = 'grid';
        document.getElementById('blockCount').textContent = result.blocks?.length || 0;
        document.getElementById('paragraphCount').textContent = result.paragraphs?.length || 0;
        document.getElementById('lineCount').textContent = result.lines?.length || 0;
        document.getElementById('wordCount').textContent = result.words?.length || 0;
        document.getElementById('symbolCount').textContent = result.symbols?.length || 0;
        document.getElementById('processingTime').textContent = result.processingTime + 'ms';

        // Display results
        displayResults(result);

      } catch (error) {
        alert('Detection failed: ' + error.message);
        console.error(error);
      } finally {
        detectBtn.disabled = false;
        detectBtn.textContent = 'Run Detection';
      }
    });

    function displayResults(result) {
      results.innerHTML = '';

      const levels = [
        { key: 'blocks', label: 'Blocks', color: 'code' },
        { key: 'paragraphs', label: 'Paragraphs', color: 'text' },
        { key: 'lines', label: 'Lines', color: 'text' },
        { key: 'words', label: 'Words', color: 'text' },
        { key: 'symbols', label: 'Symbols', color: 'text' },
      ];

      levels.forEach(({ key, label, color }) => {
        const items = result[key];
        if (!items || items.length === 0) return;

        const section = document.createElement('div');
        section.className = 'result-section';
        section.innerHTML = `<h3>${label} (${items.length})</h3>`;

        items.slice(0, 10).forEach(item => {
          const div = document.createElement('div');
          div.className = 'result-item';

          const badges = [];
          if (item.isCode) badges.push('<span class="badge code">CODE</span>');
          if (item.is_bold) badges.push('<span class="badge bold">BOLD</span>');
          if (item.is_italic) badges.push('<span class="badge italic">ITALIC</span>');

          const dims = detector.getBBoxDimensions(item.bbox);
          
          div.innerHTML = `
            <div class="text">${badges.join('')}"${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}"</div>
            <div class="meta">
              Position: (${dims.x}, ${dims.y}) | 
              Size: ${dims.width}x${dims.height} | 
              Confidence: ${item.confidence.toFixed(1)}%
            </div>
          `;
          section.appendChild(div);
        });

        if (items.length > 10) {
          const more = document.createElement('div');
          more.style.padding = '10px';
          more.style.color = '#666';
          more.style.fontSize = '14px';
          more.textContent = `... and ${items.length - 10} more`;
          section.appendChild(more);
        }

        results.appendChild(section);
      });
    }
  </script>
</body>
</html>
